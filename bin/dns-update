#!/usr/bin/env bash
#
# Run as: env CF_API_DOMAIN=yourdmain CF_API_KEY=yourtoken dns-update
#

function main {
  docker events --filter 'type=container' | while read -r ts type action cid rest; do
    echo "${type} ${action} ${cid} ${rest}"
    case "${action}" in
      start)
        ip="$(docker inspect "${cid}" | jq -r '.[].NetworkSettings.Networks[].IPAddress')"
        hostname="$(echo "$rest" | perl -pe 's{^\(}{}; s{\)$}{}; s{, }{\n}g' | grep ^dns= | cut -d= -f2-)"
        if [[ -n "${ip}" ]]; then
          if [[ -n "${hostname}" ]]; then
            cf -t A add "${hostname}" "${ip}" || cf -t A edit "${hostname}" "${ip}"
          fi
        fi
        ;;
      destroy)
        hostname="$(echo "$rest" | perl -pe 's{^\(}{}; s{\)$}{}; s{, }{\n}g' | grep ^dns= | cut -d= -f2-)"
        if [[ -n "${hostname}" ]]; then
          cf -t A rm "${hostname}"
        fi
        ;;
    esac
  done
}

main "$@"
